!function(e){var t={};function a(s){if(t[s])return t[s].exports;var i=t[s]={i:s,l:!1,exports:{}};return e[s].call(i.exports,i,i.exports,a),i.l=!0,i.exports}a.m=e,a.c=t,a.d=function(e,t,s){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(a.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)a.d(s,i,function(t){return e[t]}.bind(null,i));return s},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a(a.s=1)}([function(e,t,a){},function(e,t,a){"use strict";a.r(t);a(0);function s(e,t){let a="center";return e%t==0&&(a="left"),e%t==t-1&&(a="right"),e<=t-1&&(a="center"===a?"top":"top-"+a),e>=t**2-t&&(a="center"===a?"bottom":"bottom-"+a),a}class i{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}drawUi(e){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <p class="points">Points Game: <span id=\'game-points\'></span></p>\n      <p class="points">Total Points: <span id=\'total-points\'></span></p>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",e=>this.onNewGameClick(e)),this.saveGameEl.addEventListener("click",e=>this.onSaveGameClick(e)),this.loadGameEl.addEventListener("click",e=>this.onLoadGameClick(e)),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(e);for(let e=0;e<this.boardSize**2;e+=1){const t=document.createElement("div");t.classList.add("cell","map-tile","map-tile-"+s(e,this.boardSize)),t.addEventListener("mouseenter",e=>this.onCellEnter(e)),t.addEventListener("mouseleave",e=>this.onCellLeave(e)),t.addEventListener("click",e=>this.onCellClick(e)),this.boardEl.appendChild(t)}this.cells=Array.from(this.boardEl.children)}redrawPositions(e){for(const e of this.cells)e.innerHTML="";for(const a of e){const e=this.boardEl.children[a.position],s=document.createElement("div");s.classList.add("character",a.character.type);const i=document.createElement("div");i.classList.add("health-level");const r=document.createElement("div");r.classList.add("health-level-indicator","health-level-indicator-"+((t=a.character.health)<15?"critical":t<50?"normal":"high")),r.style.width=a.character.health+"%",i.appendChild(r),s.appendChild(i),e.appendChild(s)}var t}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach(e=>e.call(null,t))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach(e=>e.call(null,t))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach(e=>e.call(null,t))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach(e=>e.call(null))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach(e=>e.call(null))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach(e=>e.call(null))}static showError(e){alert(e)}static showMessage(e){alert(e)}selectCell(e,t="yellow"){this.deselectCell(e),this.cells[e].classList.add("selected","selected-"+t)}deselectCell(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter(e=>e.startsWith("selected")))}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=""}showDamage(e,t){return new Promise(a=>{const s=this.cells[e],i=document.createElement("span");i.textContent=t,i.classList.add("damage"),s.appendChild(i),i.addEventListener("animationend",()=>{s.removeChild(i),a()})})}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}var r={prairie:"prairie",desert:"desert",arctic:"arctic",mountain:"mountain"};class n{constructor(e,t="generic"){if(this.level=e,this.attack=0,this.defence=0,this.health=50,this.type=t,this.distanceMove=0,this.distanceAttack=0,this.areaMove=void 0,this.areaAttack=void 0,new.target===n)throw new Error("It is forbidden to create objects of the Character class")}characterInfo(){const e=String.fromCodePoint(127894),t=String.fromCodePoint(9876),a=String.fromCodePoint(128737),s=String.fromCodePoint(10084);return`${e} ${this.level} ${t} ${this.attack} ${a} ${this.defence} ${s} ${this.health}`}getArea(e,t){const a=n.getArea(e,t,this.distanceMove,this.distanceAttack);this.areaMove=a.areaMove,this.areaAttack=a.areaAttack}static getArea(e,t,a,s){const i=[],r=[],n=a>s?a:s;for(let h=1;h<=n;h+=1){const n={top:e-t*h,topRight:e-t*h+h,right:e+h,bottomRight:e+t*h+h,bottom:e+t*h,bottomLeft:e+t*h-h,left:e-h,topLeft:e-t*h-h},l=Math.trunc(e/t)*t,o=l+t-1;n.top<0&&(n.top=null,n.topRight=null,n.topLeft=null),n.bottom>t**2-1&&(n.bottom=null,n.bottomRight=null,n.bottomLeft=null),n.left<l&&(n.left=null,n.topLeft=null,n.bottomLeft=null),n.right>o&&(n.right=null,n.topRight=null,n.bottomRight=null);for(const e in n)null!==n[e]&&(h<=a&&i.push(n[e]),h<=s&&r.push(n[e]))}return{areaMove:i,areaAttack:r}}takeDamage(e){return this.health-=e,this.health>0}toDamage(e){return Math.max(this.attack-e.defence,.1*this.attack)}}class h extends n{constructor(e){super(e),this.type="Bowman",this.attack=25,this.defence=25,this.distanceMove=2,this.distanceAttack=2}}class l extends n{constructor(e){super(e),this.type="Swordsman",this.attack=40,this.defence=10,this.distanceMove=4,this.distanceAttack=1}}class o extends n{constructor(e){super(e),this.type="Magician",this.attack=10,this.defence=40,this.distanceMove=1,this.distanceAttack=4}}class c extends n{constructor(e){super(e),this.type="Undead",this.attack=40,this.defence=10,this.distanceMove=4,this.distanceAttack=1}}class m extends n{constructor(e){super(e),this.type="Vampire",this.attack=40,this.defence=10,this.distanceMove=2,this.distanceAttack=2}}class d extends n{constructor(e){super(e),this.type="Daemon",this.attack=10,this.defence=40,this.distanceMove=1,this.distanceAttack=4}}function u(e,t,a){const s=function*(e,t){for(;;){const a=Math.floor(Math.random()*e.length),s=Math.floor(Math.random()*t+1);yield new e[a](s)}}(e,t),i=[];for(let e=0;e<a;e+=1)i.push(s.next().value);return i}class p{constructor(e,t){if(!(e instanceof n))throw new Error("character must be instance of Character or its children");if("number"!=typeof t)throw new Error("position must be a number");this.character=e,this.position=t}}class v{static from(e){return"object"==typeof e?e:null}}var f={auto:"auto",pointer:"pointer",crosshair:"crosshair",notallowed:"not-allowed"};class C{constructor(e){this.storage=e}save(e){this.storage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(e){throw new Error("Invalid state")}}static createTeam(e){const t={Bowman:h,Swordsman:l,Magician:o,Undead:c,Vampire:m,Daemon:d};return e.map(e=>{const a=new t[e.character.type];return a.health=e.character.health,a.defence=e.character.defence,a.attack=e.character.attack,a.level=e.character.level,a.areaMove=e.character.areaMove,a.areaAttack=e.character.areaAttack,new p(a,e.position)})}}const g=new i;g.bindToDOM(document.querySelector("#game-container"));const y=new C(localStorage);new class{constructor(e,t){this.gamePlay=e,this.stateService=t,this.currentTheme=r.prairie,this.userCharactersList=[l,h,o],this.enemyCharactersList=[c,m,d],this.selectedCharacter=null,this.userTeam=[],this.enemyTeam=[],this.level=1,this.maxCharactersTeam=2,this.possibleEvent=null,this.hoverCharacter=null,this.hoverIndex=null,this.turn="user",this.points=0,this.totalPoints=0,this.lockBoard=!0}drawLevel(){this.gamePlay.drawUi(this.currentTheme),this.createTeams(),this.gamePlay.redrawPositions(this.userTeam.concat(this.enemyTeam)),document.getElementById("game-points").textContent=this.points,document.getElementById("total-points").textContent=this.totalPoints}init(){!1===this.loadGame()&&this.newGame(),this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),this.gamePlay.addCellClickListener(this.onCellClick.bind(this)),this.gamePlay.addNewGameListener(this.newGame.bind(this)),this.gamePlay.addLoadGameListener(this.loadGame.bind(this)),this.gamePlay.addSaveGameListener(this.saveGame.bind(this))}newGame(){this.userTeam=[],this.enemyTeam=[],this.selectedCharacter=null,this.turn="user",this.level=1,this.points=0,this.maxCharactersTeam=2,this.currentTheme=r.prairie,this.gamePlay.drawUi(this.currentTheme),this.drawLevel(),this.lockBoard=!1}saveGame(){if(this.lockBoard)return;const e={game:{userTeam:this.userTeam,enemyTeam:this.enemyTeam,level:this.level,points:this.points,currentTheme:this.currentTheme,maxCharactersTeam:this.maxCharactersTeam},totalPoints:this.totalPoints};this.stateService.save(v.from(e)),i.showMessage("Игра сохранена")}loadGame(){if(!localStorage.state)return this.lockBoard||i.showMessage("Сохраненная игра не найдена"),!1;try{const e=this.stateService.load();if(this.totalPoints=e.totalPoints,!e.game)return this.lockBoard||i.showMessage("Сохраненная игра не найдена"),!1;e.game&&(this.userTeam=e.game.userTeam,this.userTeam=C.createTeam(this.userTeam),this.enemyTeam=e.game.enemyTeam,this.enemyTeam=C.createTeam(this.enemyTeam),this.selectedCharacter=null,this.level=e.game.level,this.points=e.game.points,this.currentTheme=e.game.currentTheme,this.maxCharactersTeam=e.game.maxCharactersTeam,this.turn="user",this.gamePlay.drawUi(this.currentTheme),this.gamePlay.redrawPositions(this.userTeam.concat(this.enemyTeam)),this.lockBoard=!1),document.getElementById("game-points").textContent=this.points,document.getElementById("total-points").textContent=this.totalPoints}catch(e){i.showMessage("Не удалось загрузить игру")}}createTeams(){1===this.level&&(this.userTeam=u([l,h],this.level,this.maxCharactersTeam)),2===this.level&&(this.maxCharactersTeam=this.userTeam.length+1,this.userTeam=this.userTeam.concat(u(this.userCharactersList,1,1))),3===this.level&&(this.maxCharactersTeam=this.userTeam.length+2,this.userTeam=this.userTeam.concat(u(this.userCharactersList,2,2))),4===this.level&&(this.maxCharactersTeam=this.userTeam.length+2,this.userTeam=this.userTeam.concat(u(this.userCharactersList,3,2))),this.enemyTeam=u(this.enemyCharactersList,this.level,this.maxCharactersTeam);const e=Array.from(this.getPosition(this.gamePlay.boardSize,"user")),t=Array.from(this.getPosition(this.gamePlay.boardSize,"enemy"));this.userTeam=this.userTeam.map(t=>new p(t,e.shift())),this.enemyTeam=this.enemyTeam.map(e=>new p(e,t.shift()))}getPosition(e,t){const a=[],s=new Set;if("user"===t){a.push(0),a.push(1);for(let t=0;t<e**2;t+=1)t%e==0&&(a.push(t),a.push(t+1))}else for(let t=0;t<e**2;t+=1)(t+1)%e==0&&(a.push(t),a.push(t-1));for(;s.size!==this.maxCharactersTeam;)s.add(a[Math.floor(Math.random()*Math.floor(a.length))]);return s}onCellClick(e){this.lockBoard||("selectUserCharacter"===this.possibleEvent&&(null!==this.selectedCharacter&&this.gamePlay.deselectCell(this.selectedCharacter.position),this.selectedCharacter=this.hoverCharacter,this.selectedCharacter.character.getArea(this.selectedCharacter.position,this.gamePlay.boardSize),this.gamePlay.selectCell(e)),"selectEnemyCharacter"===this.possibleEvent&&i.showError("Нужно выбрать своего персонажа"),"attack"===this.possibleEvent&&this.attack(this.selectedCharacter,this.hoverCharacter,this.enemyTeam,e=>{e?(this.turn="enemy",this.enemyTurn()):this.level<4?this.levelUp():this.win()}),"move"===this.possibleEvent&&(this.gamePlay.deselectCell(this.selectedCharacter.position),this.gamePlay.deselectCell(e),this.move(this.selectedCharacter,e),this.gamePlay.selectCell(e),this.onCellEnter(e)))}onCellEnter(e){if(this.lockBoard)return;this.hoverIndex=e,this.gamePlay.setCursor(f.auto),this.possibleEvent=null,this.hoverCharacter=null;const t=this.userTeam.find(t=>t.position===e),a=this.enemyTeam.find(t=>t.position===e);t?(this.gamePlay.showCellTooltip(t.character.characterInfo(),e),this.gamePlay.setCursor(f.pointer),this.possibleEvent="selectUserCharacter",this.hoverCharacter=t):a?(this.hoverCharacter=a,this.gamePlay.showCellTooltip(a.character.characterInfo(),e),this.selectedCharacter&&this.selectedCharacter.character.areaAttack.indexOf(e)>=0?(this.gamePlay.setCursor(f.crosshair),this.possibleEvent="attack",this.gamePlay.selectCell(e,"red")):(this.gamePlay.setCursor(f.notallowed),this.possibleEvent="selectEnemyCharacter")):this.selectedCharacter&&this.selectedCharacter.character.areaMove.indexOf(e)>=0?(this.gamePlay.setCursor(f.pointer),this.possibleEvent="move",this.gamePlay.selectCell(e,"green")):(this.selectedCharacter&&this.gamePlay.setCursor(f.notallowed),this.possibleEvent=null)}onCellLeave(e){this.lockBoard||(this.gamePlay.hideCellTooltip(e),this.selectedCharacter&&this.selectedCharacter.position!==e&&this.gamePlay.deselectCell(e))}attack(e,t,a,s){const i=e.character.toDamage(t.character);this.gamePlay.showDamage(t.position,i).then(()=>{t.character.takeDamage(i)||(a.splice(a.indexOf(t),1),this.gamePlay.deselectCell(t.position)),this.gamePlay.redrawPositions(this.userTeam.concat(this.enemyTeam)),s(a.length)})}move(e,t){e.position=t,e.character.getArea(e.position,this.gamePlay.boardSize),this.gamePlay.redrawPositions(this.userTeam.concat(this.enemyTeam)),this.turn="user"===this.turn?"enemy":"user","enemy"===this.turn&&this.enemyTurn()}enemyTurn(){const e={enemyCharacter:null,boardindex:null,event:null},t=this.userTeam.map(e=>e.position),a=this.enemyTeam.map(e=>e.position);let s=[];if(this.userTeam.forEach(e=>{s=s.concat(e.character.areaMove)}),this.enemyTeam.some(i=>{i.character.getArea(i.position,this.gamePlay.boardSize);const r=i.character.areaAttack.filter(e=>t.indexOf(e)>=0);if(r.length>0)return e.enemyCharacter=i,e.boardindex=r[Math.floor(Math.random()*(r.length-1))],e.event="attack",!0;const n=i.character.areaMove.filter(e=>s.indexOf(e)>=0&&t.concat(a).indexOf(e)<0);n.length>0&&(e.enemyCharacter=i,e.boardindex=n[Math.floor(Math.random()*(n.length-1))],e.event="move")}),null===e.event){e.event="move",e.enemyCharacter=this.enemyTeam[Math.floor(Math.random()*(this.enemyTeam.length-1))];const s=e.enemyCharacter.character.areaMove.filter(e=>t.concat(a).indexOf(e)<0);e.boardindex=s[Math.floor(Math.random()*(s.length-1))]}if("attack"===e.event){const t=this.userTeam.find(t=>t.position===e.boardindex);this.attack(e.enemyCharacter,t,this.userTeam,e=>{this.selectedCharacter.character.health<=0&&(this.gamePlay.deselectCell(this.selectedCharacter.position),this.selectedCharacter=null,this.hoverCharacter&&(this.gamePlay.deselectCell(this.hoverCharacter.position),this.hoverCharacter=null),null!==this.hoverIndex&&this.gamePlay.deselectCell(this.hoverIndex)),e?this.turn="user":this.gameOver()})}"move"===e.event&&this.move(e.enemyCharacter,e.boardindex)}levelUp(){this.selectedCharacter=null,this.level+=1,this.maxCharactersTeam+=1,2===this.level&&(this.currentTheme=r.desert),3===this.level&&(this.currentTheme=r.arctic),4===this.level&&(this.currentTheme=r.mountain),this.userTeam=this.userTeam.map(e=>e.character),this.userTeam.forEach(e=>{this.points+=e.health,e.level+=1,e.attack=Math.floor(Math.max(e.attack,e.attack*((1.8-e.health)/100))),e.defence=Math.floor(Math.max(e.defence,e.defence*((1.8-e.health)/100))),e.health+=80,e.health>100&&(e.health=100)}),this.drawLevel()}win(){this.userTeam.forEach(e=>{this.points+=e.character.health}),this.totalPoints+=this.points,document.getElementById("game-points").textContent=this.points,document.getElementById("total-points").textContent=this.totalPoints;const e={totalPoints:this.totalPoints};this.stateService.save(v.from(e)),this.gameEnd("Вы победили!!!")}gameOver(){this.points=0,document.getElementById("game-points").textContent=this.points,this.gameEnd("Вы проиграли (((")}gameEnd(e){this.lockBoard=!0,this.gamePlay.setCursor(f.pointer);for(let e=0;e<this.gamePlay.boardSize**2-1;e+=1)this.gamePlay.deselectCell(e);i.showMessage(e)}}(g,y).init()}]);